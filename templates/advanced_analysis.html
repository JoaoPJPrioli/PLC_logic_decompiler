<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Analysis - PLC Logic Decompiler</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .analysis-card {
            transition: transform 0.2s;
        }
        .analysis-card:hover {
            transform: translateY(-2px);
        }
        .status-badge {
            font-size: 0.8em;
        }
        .progress-bar {
            transition: width 0.3s;
        }
        .results-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .graph-visualization {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-cpu"></i> PLC Logic Decompiler
            </a>
            <div class="navbar-nav">
                <a class="nav-link" href="/">Home</a>
                <a class="nav-link" href="/upload">Upload</a>
                <a class="nav-link active" href="/analysis/advanced">Advanced Analysis</a>
                <a class="nav-link" href="/generate">Generate Code</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="bi bi-graph-up"></i> Advanced PLC Analysis Dashboard
                </h1>
                
                <!-- Analysis Status -->
                <div class="alert alert-info">
                    <h5><i class="bi bi-info-circle"></i> Analysis Status</h5>
                    <p>Perform advanced analysis on your uploaded PLC program including graph analysis, routine structure, and timer/counter analysis.</p>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Graph Analysis Card -->
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card analysis-card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-diagram-3"></i> Graph Analysis
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text">Build comprehensive graph structures showing control flow, data dependencies, and instruction networks.</p>
                        <div class="mb-3">
                            <button id="buildGraphBtn" class="btn btn-primary">
                                <i class="bi bi-play-circle"></i> Build Graphs
                            </button>
                            <span id="graphStatus" class="badge bg-secondary status-badge ms-2">Not Started</span>
                        </div>
                        <div id="graphProgress" class="progress mb-3" style="display: none;">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div id="graphResults" class="results-container" style="display: none;">
                            <h6>Graph Analysis Results</h6>
                            <div id="graphSummary"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Routine Analysis Card -->
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card analysis-card h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-code-square"></i> Routine Analysis
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text">Analyze program structure, subroutine calls, and execution hierarchy.</p>
                        <div class="mb-3">
                            <button id="analyzeRoutinesBtn" class="btn btn-success">
                                <i class="bi bi-search"></i> Analyze Routines
                            </button>
                            <span id="routineStatus" class="badge bg-secondary status-badge ms-2">Not Started</span>
                        </div>
                        <div id="routineResults" class="results-container" style="display: none;">
                            <h6>Routine Analysis Results</h6>
                            <div id="routineSummary"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timer/Counter Analysis Card -->
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card analysis-card h-100">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-stopwatch"></i> Timer/Counter Analysis
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text">Analyze timers, counters, and their relationships in the PLC program.</p>
                        <div class="mb-3">
                            <button id="analyzeTimersBtn" class="btn btn-warning">
                                <i class="bi bi-clock"></i> Analyze Timers
                            </button>
                            <span id="timerStatus" class="badge bg-secondary status-badge ms-2">Not Started</span>
                        </div>
                        <div id="timerResults" class="results-container" style="display: none;">
                            <h6>Timer/Counter Analysis Results</h6>
                            <div id="timerSummary"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Graph Visualization Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-eye"></i> Graph Visualization
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="graphType" class="form-label">Graph Type:</label>
                                <select id="graphType" class="form-select">
                                    <option value="CONTROL_FLOW">Control Flow</option>
                                    <option value="DATA_DEPENDENCY">Data Dependency</option>
                                    <option value="INSTRUCTION_NETWORK">Instruction Network</option>
                                    <option value="EXECUTION_FLOW">Execution Flow</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="visFormat" class="form-label">Output Format:</label>
                                <select id="visFormat" class="form-select">
                                    <option value="HTML">Interactive HTML</option>
                                    <option value="JSON">JSON Data</option>
                                    <option value="SVG">SVG Vector</option>
                                    <option value="PNG">PNG Image</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="outputName" class="form-label">Output Name:</label>
                                <input type="text" id="outputName" class="form-control" value="plc_graph" placeholder="Output filename">
                            </div>
                        </div>
                        <div class="mb-3">
                            <button id="visualizeBtn" class="btn btn-info" disabled>
                                <i class="bi bi-image"></i> Generate Visualization
                            </button>
                            <span id="visualizeStatus" class="badge bg-secondary status-badge ms-2">Graph Required</span>
                        </div>
                        <div id="visualizationResults" class="graph-visualization" style="display: none;">
                            <h6>Visualization Generated</h6>
                            <div id="visualizationInfo"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Graph Query Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-search"></i> Graph Query Interface
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="queryType" class="form-label">Query Type:</label>
                                <select id="queryType" class="form-select">
                                    <option value="PATH_ANALYSIS">Path Analysis</option>
                                    <option value="PATTERN_MATCHING">Pattern Matching</option>
                                    <option value="CENTRALITY_ANALYSIS">Centrality Analysis</option>
                                    <option value="DEPENDENCY_ANALYSIS">Dependency Analysis</option>
                                    <option value="OPTIMIZATION_HINTS">Optimization Hints</option>
                                    <option value="SECURITY_ANALYSIS">Security Analysis</option>
                                    <option value="PERFORMANCE_ANALYSIS">Performance Analysis</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="queryParams" class="form-label">Query Parameters (JSON):</label>
                                <textarea id="queryParams" class="form-control" rows="3" placeholder='{"source_pattern": "Main.*", "target_pattern": ".*Timer.*"}'></textarea>
                            </div>
                        </div>
                        <div class="mb-3">
                            <button id="executeQueryBtn" class="btn btn-dark" disabled>
                                <i class="bi bi-play"></i> Execute Query
                            </button>
                            <span id="queryStatus" class="badge bg-secondary status-badge ms-2">Graph Required</span>
                        </div>
                        <div id="queryResults" class="results-container" style="display: none;">
                            <h6>Query Results</h6>
                            <div id="queryOutput"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let graphBuilt = false;

        // Build Graph functionality
        document.getElementById('buildGraphBtn').addEventListener('click', async function() {
            const btn = this;
            const status = document.getElementById('graphStatus');
            const progress = document.getElementById('graphProgress');
            const results = document.getElementById('graphResults');
            
            btn.disabled = true;
            status.textContent = 'Building...';
            status.className = 'badge bg-warning status-badge ms-2';
            progress.style.display = 'block';
            
            try {
                const response = await fetch('/api/graph/build', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({graph_type: 'all'})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    status.textContent = 'Completed';
                    status.className = 'badge bg-success status-badge ms-2';
                    graphBuilt = true;
                    
                    // Enable dependent buttons
                    document.getElementById('visualizeBtn').disabled = false;
                    document.getElementById('executeQueryBtn').disabled = false;
                    document.getElementById('visualizeStatus').textContent = 'Ready';
                    document.getElementById('queryStatus').textContent = 'Ready';
                    
                    // Show results
                    results.style.display = 'block';
                    document.getElementById('graphSummary').innerHTML = `
                        <ul class="list-unstyled">
                            <li><strong>Graphs Built:</strong> ${data.summary.graphs_built}</li>
                            <li><strong>Control Paths:</strong> ${data.summary.control_paths}</li>
                            <li><strong>Recommendations:</strong> ${data.summary.recommendations}</li>
                        </ul>
                    `;
                } else {
                    throw new Error('Graph building failed');
                }
            } catch (error) {
                status.textContent = 'Failed';
                status.className = 'badge bg-danger status-badge ms-2';
                console.error('Error building graph:', error);
            } finally {
                btn.disabled = false;
                progress.style.display = 'none';
            }
        });

        // Analyze Routines functionality
        document.getElementById('analyzeRoutinesBtn').addEventListener('click', async function() {
            const btn = this;
            const status = document.getElementById('routineStatus');
            const results = document.getElementById('routineResults');
            
            btn.disabled = true;
            status.textContent = 'Analyzing...';
            status.className = 'badge bg-warning status-badge ms-2';
            
            try {
                const response = await fetch('/api/routine/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const data = await response.json();
                
                if (data.success) {
                    status.textContent = 'Completed';
                    status.className = 'badge bg-success status-badge ms-2';
                    
                    results.style.display = 'block';
                    document.getElementById('routineSummary').innerHTML = `
                        <ul class="list-unstyled">
                            <li><strong>Total Routines:</strong> ${data.program_structure.total_routines}</li>
                            <li><strong>Subroutines:</strong> ${data.program_structure.total_subroutines}</li>
                            <li><strong>Max Call Depth:</strong> ${data.program_structure.max_call_depth}</li>
                            <li><strong>Recursive Calls:</strong> ${data.program_structure.recursive_calls_count}</li>
                        </ul>
                    `;
                } else {
                    throw new Error('Routine analysis failed');
                }
            } catch (error) {
                status.textContent = 'Failed';
                status.className = 'badge bg-danger status-badge ms-2';
                console.error('Error analyzing routines:', error);
            } finally {
                btn.disabled = false;
            }
        });

        // Analyze Timers functionality  
        document.getElementById('analyzeTimersBtn').addEventListener('click', async function() {
            const btn = this;
            const status = document.getElementById('timerStatus');
            const results = document.getElementById('timerResults');
            
            btn.disabled = true;
            status.textContent = 'Analyzing...';
            status.className = 'badge bg-warning status-badge ms-2';
            
            try {
                const response = await fetch('/api/timer-counter/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const data = await response.json();
                
                if (data.success) {
                    status.textContent = 'Completed';
                    status.className = 'badge bg-success status-badge ms-2';
                    
                    results.style.display = 'block';
                    document.getElementById('timerSummary').innerHTML = `
                        <ul class="list-unstyled">
                            <li><strong>Total Timers:</strong> ${data.summary.total_timers}</li>
                            <li><strong>Total Counters:</strong> ${data.summary.total_counters}</li>
                            <li><strong>Timing Chains:</strong> ${data.summary.timing_chains}</li>
                            <li><strong>Counting Chains:</strong> ${data.summary.counting_chains}</li>
                        </ul>
                    `;
                } else {
                    throw new Error('Timer/Counter analysis failed');
                }
            } catch (error) {
                status.textContent = 'Failed';
                status.className = 'badge bg-danger status-badge ms-2';
                console.error('Error analyzing timers:', error);
            } finally {
                btn.disabled = false;
            }
        });

        // Visualize Graph functionality
        document.getElementById('visualizeBtn').addEventListener('click', async function() {
            if (!graphBuilt) return;
            
            const btn = this;
            const status = document.getElementById('visualizeStatus');
            const results = document.getElementById('visualizationResults');
            
            btn.disabled = true;
            status.textContent = 'Generating...';
            status.className = 'badge bg-warning status-badge ms-2';
            
            try {
                const response = await fetch('/api/visualize/graph', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        graph_type: document.getElementById('graphType').value,
                        format: document.getElementById('visFormat').value,
                        output_name: document.getElementById('outputName').value || 'plc_graph'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    status.textContent = 'Generated';
                    status.className = 'badge bg-success status-badge ms-2';
                    
                    results.style.display = 'block';
                    document.getElementById('visualizationInfo').innerHTML = `
                        <p><strong>Format:</strong> ${data.format}</p>
                        <p><strong>File:</strong> ${data.output_path}</p>
                        <a href="${data.download_url}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-download"></i> Download
                        </a>
                    `;
                } else {
                    throw new Error(data.error || 'Visualization failed');
                }
            } catch (error) {
                status.textContent = 'Failed';
                status.className = 'badge bg-danger status-badge ms-2';
                console.error('Error generating visualization:', error);
            } finally {
                btn.disabled = false;
            }
        });

        // Execute Query functionality
        document.getElementById('executeQueryBtn').addEventListener('click', async function() {
            if (!graphBuilt) return;
            
            const btn = this;
            const status = document.getElementById('queryStatus');
            const results = document.getElementById('queryResults');
            
            btn.disabled = true;
            status.textContent = 'Executing...';
            status.className = 'badge bg-warning status-badge ms-2';
            
            try {
                let parameters = {};
                const paramText = document.getElementById('queryParams').value.trim();
                if (paramText) {
                    parameters = JSON.parse(paramText);
                }
                
                const response = await fetch('/api/graph/query', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        query_type: document.getElementById('queryType').value,
                        parameters: parameters
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    status.textContent = 'Completed';
                    status.className = 'badge bg-success status-badge ms-2';
                    
                    results.style.display = 'block';
                    document.getElementById('queryOutput').innerHTML = `
                        <p><strong>Query ID:</strong> ${data.query_id}</p>
                        <p><strong>Query Type:</strong> ${data.query_type}</p>
                        <p><strong>Execution Time:</strong> ${data.execution_time.toFixed(3)}s</p>
                        <p><strong>Confidence:</strong> ${(data.confidence_score * 100).toFixed(1)}%</p>
                        <p><strong>Results:</strong> ${data.results.length} items found</p>
                        <pre class="bg-light p-2 mt-2"><code>${JSON.stringify(data.results, null, 2)}</code></pre>
                    `;
                } else {
                    throw new Error(data.error || 'Query failed');
                }
            } catch (error) {
                status.textContent = 'Failed';
                status.className = 'badge bg-danger status-badge ms-2';
                console.error('Error executing query:', error);
                document.getElementById('queryOutput').innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>
