{% extends "base.html" %}

{% block title %}Graph Visualization - PLC Logic Decompiler{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>üï∏Ô∏è PLC Logic Graph Visualization</h2>
        <p class="text-muted">Interactive visualization of your PLC logic structure, dependencies, and execution flow.</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>Graph Controls</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Graph Type</label>
                        <select class="form-select" id="graphType">
                            <option value="control_flow">Control Flow</option>
                            <option value="data_dependency">Data Dependencies</option>
                            <option value="instruction_network">Instruction Network</option>
                            <option value="execution_flow">Execution Flow</option>
                            <option value="dashboard">Complete Dashboard</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Output Format</label>
                        <select class="form-select" id="outputFormat">
                            <option value="HTML">Interactive HTML</option>
                            <option value="SVG">SVG Vector</option>
                            <option value="PNG">PNG Image</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Layout</label>
                        <select class="form-select" id="layoutType">
                            <option value="hierarchical">Hierarchical</option>
                            <option value="force_directed">Force Directed</option>
                            <option value="circular">Circular</option>
                            <option value="tree">Tree Layout</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Actions</label><br>
                        <button class="btn btn-primary" onclick="buildGraph()">Build Graph</button>
                        <button class="btn btn-success" onclick="visualizeGraph()" disabled id="visualizeBtn">Visualize</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6>Graph Statistics</h6>
            </div>
            <div class="card-body" id="graphStats">
                <p class="text-muted">Build a graph to see statistics</p>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6>Graph Query</h6>
            </div>
            <div class="card-body">
                <select class="form-select mb-2" id="queryType">
                    <option value="PATH_ANALYSIS">Path Analysis</option>
                    <option value="PATTERN_MATCHING">Pattern Matching</option>
                    <option value="CENTRALITY_ANALYSIS">Centrality Analysis</option>
                </select>
                <input type="text" class="form-control mb-2" placeholder="Source node" id="sourceNode">
                <input type="text" class="form-control mb-2" placeholder="Target node" id="targetNode">
                <button class="btn btn-info btn-sm" onclick="executeQuery()">Execute Query</button>
                <div id="queryResults" class="mt-2"></div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6>File Information</h6>
            </div>
            <div class="card-body">
                {% if result %}
                <div class="row">
                    <div class="col-6"><strong>Controller:</strong></div>
                    <div class="col-6">{{ result.controller_info.get('name', 'Unknown') }}</div>
                    <div class="col-6"><strong>Tags:</strong></div>
                    <div class="col-6">{{ result.tags|length }}</div>
                    <div class="col-6"><strong>Programs:</strong></div>
                    <div class="col-6">{{ result.programs|length }}</div>
                    <div class="col-6"><strong>Processing Time:</strong></div>
                    <div class="col-6">{{ "%.2f"|format(result.processing_time) }}s</div>
                </div>
                {% else %}
                <p class="text-muted">No file processed</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between">
                <h6>Visualization Output</h6>
                <div>
                    <button class="btn btn-sm btn-outline-secondary" onclick="downloadVisualization()" id="downloadBtn" disabled>Download</button>
                    <button class="btn btn-sm btn-outline-info" onclick="fullScreen()" id="fullscreenBtn" disabled>Full Screen</button>
                </div>
            </div>
            <div class="card-body" style="min-height: 500px;">
                <div id="visualizationContainer">
                    <div class="text-center text-muted p-5">
                        <i class="fas fa-project-diagram fa-3x mb-3"></i>
                        <p>Click "Build Graph" to start visualization</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6>Graph Analysis Results</h6>
            </div>
            <div class="card-body">
                <div id="analysisResults">
                    <p class="text-muted">Graph analysis will appear here after building graphs</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentGraphData = null;
let currentVisualizationPath = null;

async function buildGraph() {
    const graphType = document.getElementById('graphType').value;
    
    try {
        document.getElementById('graphStats').innerHTML = '<div class="spinner-border spinner-border-sm"></div> Building graph...';
        
        const response = await fetch('/api/graph/build', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({graph_type: graphType})
        });
        
        const result = await response.json();
        
        if (result.success) {
            currentGraphData = result;
            document.getElementById('visualizeBtn').disabled = false;
            
            // Update statistics
            const stats = result.statistics || {};
            let statsHtml = '<div class="row">';
            
            if (stats.overall) {
                statsHtml += `
                    <div class="col-6"><strong>Total Nodes:</strong></div>
                    <div class="col-6">${stats.overall.total_nodes || 0}</div>
                    <div class="col-6"><strong>Total Edges:</strong></div>
                    <div class="col-6">${stats.overall.total_edges || 0}</div>
                    <div class="col-6"><strong>Graphs Built:</strong></div>
                    <div class="col-6">${stats.overall.total_graphs || 0}</div>
                `;
            } else {
                statsHtml += `
                    <div class="col-6"><strong>Nodes:</strong></div>
                    <div class="col-6">${result.summary?.total_nodes || 0}</div>
                    <div class="col-6"><strong>Edges:</strong></div>
                    <div class="col-6">${result.summary?.total_edges || 0}</div>
                    <div class="col-6"><strong>Graphs:</strong></div>
                    <div class="col-6">${result.graphs_built || 0}</div>
                `;
            }
            statsHtml += '</div>';
            
            document.getElementById('graphStats').innerHTML = statsHtml;
            
            // Update analysis results
            if (result.recommendations && result.recommendations.length > 0) {
                document.getElementById('analysisResults').innerHTML = `
                    <h6>Recommendations:</h6>
                    <ul>
                        ${result.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                `;
            } else {
                document.getElementById('analysisResults').innerHTML = '<p class="text-success">Graph built successfully! Ready for visualization.</p>';
            }
            
            showAlert('Graph built successfully! Click "Visualize" to create the visualization.', 'success');
        } else {
            throw new Error(result.error || 'Failed to build graph');
        }
    } catch (error) {
        document.getElementById('graphStats').innerHTML = `<div class="text-danger">Error: ${error.message}</div>`;
        showAlert(`Error building graph: ${error.message}`, 'danger');
        console.error('Graph building error:', error);
    }
}

async function visualizeGraph() {
    const graphType = document.getElementById('graphType').value;
    const outputFormat = document.getElementById('outputFormat').value;
    const layoutType = document.getElementById('layoutType').value;
    
    try {
        document.getElementById('visualizationContainer').innerHTML = '<div class="text-center p-4"><div class="spinner-border"></div><br>Generating visualization...</div>';
        
        const response = await fetch('/api/visualize/graph', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                graph_type: graphType,
                format: outputFormat,
                layout: layoutType,
                output_name: `plc_graph_${graphType.toLowerCase()}`
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            currentVisualizationPath = result.output_path;
            document.getElementById('downloadBtn').disabled = false;
            document.getElementById('fullscreenBtn').disabled = false;
            
            if (outputFormat === 'HTML') {
                // Load HTML visualization in iframe
                document.getElementById('visualizationContainer').innerHTML = `
                    <iframe src="${result.download_url}" style="width: 100%; height: 500px; border: 1px solid #ddd;"></iframe>
                `;
            } else {
                // Show image or SVG
                document.getElementById('visualizationContainer').innerHTML = `
                    <div class="text-center">
                        <img src="${result.download_url}" class="img-fluid" style="max-height: 500px;">
                        <br><small class="text-muted">Format: ${result.format}</small>
                    </div>
                `;
            }
            
            showAlert('Visualization generated successfully!', 'success');
            
        } else {
            throw new Error(result.error || 'Failed to generate visualization');
        }
    } catch (error) {
        document.getElementById('visualizationContainer').innerHTML = `<div class="text-danger text-center p-4">Error: ${error.message}</div>`;
        showAlert(`Error generating visualization: ${error.message}`, 'danger');
        console.error('Visualization error:', error);
    }
}

async function executeQuery() {
    const queryType = document.getElementById('queryType').value;
    const sourceNode = document.getElementById('sourceNode').value;
    const targetNode = document.getElementById('targetNode').value;
    
    if (!currentGraphData) {
        showAlert('Please build a graph first', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/graph/query', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                query_type: queryType,
                parameters: {
                    source: sourceNode,
                    target: targetNode
                }
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('queryResults').innerHTML = `
                <div class="alert alert-info">
                    <strong>Query Results:</strong><br>
                    Found ${result.results ? result.results.length : 0} results<br>
                    ${result.confidence_score ? `<small>Confidence: ${result.confidence_score}/10</small>` : ''}
                </div>
            `;
        } else {
            document.getElementById('queryResults').innerHTML = `<div class="alert alert-warning">No results found</div>`;
        }
    } catch (error) {
        document.getElementById('queryResults').innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
    }
}

function downloadVisualization() {
    if (currentVisualizationPath) {
        window.open(currentVisualizationPath, '_blank');
    }
}

function fullScreen() {
    if (currentVisualizationPath) {
        window.open(currentVisualizationPath, '_blank', 'fullscreen=yes');
    }
}

function showAlert(message, type = 'info') {
    // Create alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at top of page
    const container = document.querySelector('.container-fluid') || document.body;
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Graph visualization page loaded');
});
</script>
{% endblock %}
